---
title: "OTU analysis Cleaned"
author: "Alejandra"
date: "March 26, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
##load packages needed to split up the data
library(dplyr)
library(splitstackshape)
library(reshape)
Biotrap_full_data = read.csv("../Data/Organized-Data/Biotrap-OTU-data.csv")
Full_biotrap_dataframe = data.frame(Biotrap_full_data[c(4:35)])
##This has far too many observations to do an NMDS. We can reduce the number of
##observations by making a data frame based on a taxonomic rank Split up the
##dataframe by taxonomy by adding taxonomic ranks as columns
TaxSplit=cSplit(Full_biotrap_dataframe, "Taxonomy", ";")


names(TaxSplit)[32]="Kingdom"

names(TaxSplit)[33]="Phylum"

names(TaxSplit)[34]="Class"

names(TaxSplit)[35]="Order"

names(TaxSplit)[36]="Family"

names(TaxSplit)[37]="Genus"


##arrange by class since it is more descriptive than kingdom and might give
##insight into how the data is arranged
ClassesMelt=melt(TaxSplit, id.vars = "Class", measure.vars = c("LBT03","LBT04","LBT05","LBT07","LBT08","LBT09","LBT10","LBT89", "LBT90", "LBT91" ,"LBT92" , "LBT93","LBT94", "LBT96","LBT97","LBT98","LBTL10","LBTL7","LBTL9A","AxBT01" , "AxBT03", "AxBT05", "AxBT08", "AxBT10", "AxBT18", "AxBT36", "AxBT38", "AxBT43", "AxBT44", "AxBT47", "AxBT66")) 
##make it a data frame
ClassesMelt_df = data.frame(ClassesMelt)
##now rearrange to wide format using "reshape" function
ClassMelt_wide_df = reshape(ClassesMelt_df, idvar = "Class", timevar = "variable", direction = "wide")
#setnames (reshape(ClassesMelt_df, idvar = "Class", timevar = "variable", direction = "wide"), + c("class",""))
##remove "class" variable to create a data frame for nmds
library(dplyr)
row.names(ClassMelt_wide_df)=ClassMelt_wide_df$Class
ClassMelt_wide_df$Class=NULL
ClassMelt_wide_df
##Now we can perform an NMDS analysis

##plot NMDS to visualize variation
Class_final_df = t(ClassMelt_wide_df) 
View(Class_final_df)
#as.data.frame(Class_final_df)

library(vegan)
classNMDS=metaMDS(Class_final_df)

plot(classNMDS)
pdf('../Figures/nmds_fig_1.pdf')
dev.off()


plot(classNMDS)
orditorp(classNMDS,display = "site", cex=1.05,air=0.05)
pdf('../Figures/NMDS_by_site.pdf')
dev.off()

plot(classNMDS)
orditorp(classNMDS,display = "species", labels = 'class', cex=0.5,air=0.05)
pdf('../Figures/NMDS_by_class.pdf')
dev.off()

plot(classNMDS)
orditorp(classNMDS,display="species", col="red",air=0.01)
orditorp(classNMDS,display="sites",cex=1.25,air=0.01)
pdf('../Figures/NMDS_class_and_site.pdf')
dev.off()

otus_dist = as.matrix((vegdist(Class_final_df, "bray")))
NMDS = metaMDS(otus_dist)
#build a data frame with nmds metadata
MDS1 = NMDS$points[,1]
 MDS2 = NMDS$points[,2]
 NMDS_2 = data.frame(MDS1 = MDS1, MDS2 = MDS2, Sample_site = BioTrapCharacteristics$group, Location = BioTrapCharacteristics$seamount)

Duration = BioTrapCharacteristics$Duration
Year = BioTrapCharacteristics$year

library(ggplot2)
ggplot(NMDS_2, aes(x=MDS1, y=MDS2, col=Location)) +
 geom_point(aes(col = as.factor(Duration))) +
 stat_ellipse() +
 theme_bw() +
 labs(title = "NMDS Plot with Duration")

#plot with just the nmds
ggplot(NMDS, aes(x=MDS1, y=MDS2, col=Location)) +
 geom_point() +
 stat_ellipse() +
 theme_bw() +
 labs(title = "NMDS Plot")
#plot with the year
ggplot(NMDS_2, aes(x=MDS1, y=MDS2, col=Location)) +
 geom_point(aes(shape = as.factor(Year))) +
 stat_ellipse() +
 theme_bw() +
 labs(title = "NMDS Plot using Year")
library(vegan)
data("dune")
mod = cca(Class_final_df~Year)
mod2 = cca(Class_final_df~Duration)
summary(mod)
plot(mod)
with(Class_final_df, ordihull(mod,BioTrapCharacteristics$marker,
                              scaling = "symmetric", label = TRUE))

anosim(otus_dist, grouping = BioTrapCharacteristics$seamount) 

```

Adding Environmental Data
```{r}
Biotrap_Characteristics_full = read.csv("../Data/Organized-data/BioTrapCharacteristics.csv")

#remove unnecessary variables that have too many NA values
library(dplyr)
Biotrap_env_Characteristics = select(Biotrap_Characteristics_full, -Temperature,-H2S,-pH,-Fe.II.)

Biotrap_env_Characteristics
                                                                        
```


